#--------------------------
# xebro GmbH - Makefile - 1.0.4
#--------------------------
.ONESHELL:
.SHELLFLAGS := -eu -c
.PHONY: help $(MAKEFILE_LIST) start stop build install

XO_CORE_VERSION=1.0.4
XO_ROOT_DIR=$(shell pwd)
XO_MODULES_DIR=docker
XO_CONFIG_DIR=${XO_ROOT_DIR}/${XO_MODULES_DIR}/config
XO_MODULES_BRANCH?=main
XO_MODULES_REPO_BASE?=https://github.com/xebro-gmbh

CFLAGS=-g
export CFLAGS


ifeq ($(UNAME),Darwin)
     SHELL := /opt/local/bin/bash
     OS_X  := true
else ifneq (,$(wildcard /etc/redhat-release))
     OS_RHEL := true
else
     OS_DEB  := true
     SHELL := /bin/bash
endif

USER_UID=$(shell id -u)
USER_GID=$(shell id -g)

APP_ENV=prod


-include .env
-include .env.local

COMPOSE_FILES=$(shell find ${XO_MODULES_DIR} -type f -name "compose.yaml" | sort | sed 's/^/-f /')
DOCKER_COMPOSE=docker compose ${COMPOSE_FILES}

export

define clone_module
	@rm -rf ${XO_MODULES_DIR}/$(2)
	@git clone --branch ${XO_MODULES_BRANCH} --depth 1 $(1) ${XO_MODULES_DIR}/$(2)
endef

#### end of configuring the app, start using the variables


-include ${XO_MODULES_DIR}/*/Makefile
-include bin/Makefile

#### starting hooks for other makefiles

start: post_start ## start development environment
post_start:

stop: ## stop development environment

install: post_install ## init project and install all dependencies
post_install:

test: ## Run tests to verify app is running as expected

build:

install.core:
	$(call clone_module,"${XO_MODULES_REPO_BASE}/make-core.git","core")

install.php:
	$(call clone_module,"${XO_MODULES_REPO_BASE}/make-apache-php.git","php")

install.node:
	$(call clone_module,"${XO_MODULES_REPO_BASE}/make-node.git","node")

install.postgres:
	$(call clone_module,"${XO_MODULES_REPO_BASE}/make-postgres.git","postgres")

install.mailcatcher:
	$(call clone_module,"${XO_MODULES_REPO_BASE}/make-mailcatcher.git","mailcatcher")

install.localstack:
	$(call clone_module,"${XO_MODULES_REPO_BASE}/make-localstack.git","localstack")

install.playwright:
	$(call clone_module,"${XO_MODULES_REPO_BASE}/make-playwright.git","playwright")

install.worker:
	$(call clone_module,"${XO_MODULES_REPO_BASE}/make-worker.git","worker")

install.modules: install.core install.php install.node install.postgres install.mailcatcher install.localstack install.playwright install.worker

help:
	$(call add_help,./Makefile,"xebro")

debug:
